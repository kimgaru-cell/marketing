<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
      const supabase = createClient(
        'https://azdnwqrirgpedwcuaqdi.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZG53cXJpcmdwZWR3Y3VhcWRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4MDU4NTIsImV4cCI6MjA2MzM4MTg1Mn0.wpsdKaG0XWwWRXrXVHzwliZ99EYjvHpAizqQbu5djn8'
      );

      window.supabase = supabase;
    
      async function checkAuthAndRedirect() {
        try {
          const { data: { session }, error } = await supabase.auth.getSession();
          const user = session?.user;
    
          if (error || !user) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "login.html";
            return false;
          }

          const userInfoElement = document.getElementById('user-info');
          if (userInfoElement) {
              userInfoElement.textContent = `${user.email} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
          } else {
              console.warn("checkAuthAndRedirect: 'user-info' element not found yet.");
          }
    
          // ì„¸ì…˜ ë§Œë£Œ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
          supabase.auth.onAuthStateChange((_event, session) => {
            if (!session) {
              alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì–´ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
              window.location.href = "login.html";
            }
          });
          return true; // ì¸ì¦ ì„±ê³µ
        } catch (e) {
          console.error("ì¸ì¦ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", e);
          alert("ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
          window.location.href = "login.html";
          return false;
        }
      }
        
      async function initializeDashboard() {
        const isAuthenticated = await checkAuthAndRedirect();
        if (isAuthenticated) {
          if (typeof fetchUrls === 'function') fetchUrls();
          if (typeof fetchClickStats === 'function') fetchClickStats();

          // ì„¸ì…˜ ì²´í¬ íƒ€ì´ë¨¸ ì¶”ê°€
          setInterval(async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
              alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
              window.location.href = "login.html";
            }
          }, 5 * 60 * 1000);
        }
      }

      window.checkAuthAndRedirect = checkAuthAndRedirect;
      window.initializeDashboard = initializeDashboard;

    // ë¹„í™œë™ 30ë¶„ í›„ ìë™ ë¡œê·¸ì•„ì›ƒ
    let inactivityTimer;
    const logoutAfterInactivity = () => {
      alert("30ë¶„ ì´ìƒ í™œë™ì´ ì—†ì–´ ìë™ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.");
      supabase.auth.signOut();
      window.location.href = "login.html";
    };
    
    const resetInactivityTimer = () => {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(logoutAfterInactivity, 30 * 60 * 1000); // 30ë¶„
    };
    
    // ì‚¬ìš©ì í™œë™ ê°ì§€
    ['click', 'mousemove', 'keydown', 'scroll'].forEach(event => {
      document.addEventListener(event, resetInactivityTimer);
    });
    
    // ì‹œì‘ ì‹œ íƒ€ì´ë¨¸ ì„¤ì •
    resetInactivityTimer();
    </script>
    
</head>

<body>
<!-- ë©”ë‰´ ì‚½ì… ìœ„ì¹˜ -->
<div id="menu-container"></div>

<!-- ë©”ë‰´ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="public/js/loadMenu.js"></script>

  <header class="bg-indigo-600 text-white py-2">
    <div class="container mx-auto px-4 flex justify-between items-center flex-wrap gap-2">
      <h1 class="text-2xl font-bold text-white">ğŸ“Š ë‹¨ì¶• URL ëŒ€ì‹œë³´ë“œ</h1>
      <div class="flex flex-col md:flex-row items-end md:items-center justify-end space-y-1 md:space-y-0 md:space-x-4 text-sm text-white">
        <div id="user-info"></div>
        <button id="logout-btn" class="px-3 py-1 bg-white text-indigo-700 rounded hover:bg-indigo-100 transition">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
  </header>

      
  <main class="container mx-auto px-4 py-4 flex-grow">
    <!-- í´ë¦­ í†µê³„ ì°¨íŠ¸ -->
    <section class="bg-white rounded shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-4 text-indigo-700">ğŸ“… ë‚ ì§œë³„ í´ë¦­ ìˆ˜</h2>
      <canvas id="clickChart" height="100"></canvas>
    </section>
      
      <!-- [ê²€ìƒ‰/í•„í„°/ë‹¤ìš´ë¡œë“œ UI] -->
      <section class="flex flex-wrap gap-2 mb-4">
        <input type="date" id="start-date" class="border rounded px-2 py-1">
        <input type="date" id="end-date" class="border rounded px-2 py-1">
        <input type="text" id="search-input" placeholder="ë©”ëª¨/URL ê²€ìƒ‰" class="border rounded px-2 py-1">
        <button id="search-btn" class="bg-indigo-500 text-white px-3 py-1 rounded">ê²€ìƒ‰</button>
        <button onclick="setDateRange(1)" class="bg-gray-300 px-2 py-1 rounded text-sm">ì–´ì œ</button>
        <button onclick="setDateRange(7)" class="bg-gray-300 px-2 py-1 rounded text-sm">7ì¼ ì „</button>
        <button onclick="setDateRange(30)" class="bg-gray-300 px-2 py-1 rounded text-sm">30ì¼ ì „</button>
        <button onclick="setDateRange(90)" class="bg-gray-300 px-2 py-1 rounded text-sm">90ì¼ ì „</button>
        <button id="export-btn" class="bg-green-600 text-white px-3 py-1 rounded">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button id="reset-btn" class="bg-gray-500 text-white px-3 py-1 rounded">ì „ì²´ ë³´ê¸°</button>
      </section>

    <section class="overflow-x-auto">
      <table class="min-w-full bg-white rounded shadow">
        <thead>
          <tr class="bg-indigo-100 text-left text-sm font-semibold text-gray-700">
            <th class="px-4 py-3">ìƒì„±ì¼</th>
            <th class="px-4 py-3">ë‹¨ì¶• URL</th>
            <th class="px-4 py-3">ì›ë³¸ URL</th>
            <th class="px-4 py-3">í´ë¦­ ìˆ˜</th>
            <th class="px-4 py-3">ë©”ëª¨</th>
            <th class="px-4 py-3">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="url-table-body" class="text-gray-800 text-sm"></tbody>
      </table>
    </section>
  </main>
    
</body>

    <!-- main page -->
    <div id="footer-placeholder"></div>
    
    <script>
      fetch('footer.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('footer-placeholder').innerHTML = data;
        });
    </script>

   <script>
      function copyUrl(url) {
        navigator.clipboard.writeText(url).then(() => {
          alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
      }
    
      function deleteUrl(shortCode) {
        if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          fetch('/.netlify/functions/delete-url', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ shortCode })
            })
              .then(res => res.json())
              .then(data => {
                if (data.message === 'ì‚­ì œ ì™„ë£Œ') {
                  alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                  location.reload(); // ë˜ëŠ” fetchUrls(); ë¡œ ê°±ì‹ 
                } else {
                  alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.message || 'ì˜¤ë¥˜'));
                }
              })
              .catch(err => {
                console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", err);
                alert('ì‚­ì œ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
              });
          }
        }
    
      async function fetchUrls() {
          const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();
          const user = session?.user;
    
          if (sessionError || !user) {
              console.error("fetchUrls: User session not found or error fetching session.", sessionError);
              document.getElementById('url-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-4">ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</td></tr>';
              return;
          }
        
          console.log("fetchUrls: Fetching URLs for user:", user.id); // ë””ë²„ê¹…ìš© ë¡œê·¸
          try {
              const res = await fetch('/.netlify/functions/fetch-urls', { //
                method: 'POST', //
                headers: {
                  'Content-Type': 'application/json' //
                },
                body: JSON.stringify({ user_id: user.id })  // ì‚¬ìš©ì ID ì „ë‹¬
              });
            
              if (!res.ok) {
                const errorData = await res.json().catch(() => ({ message: "ì„œë²„ ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨" }));
                console.error("fetchUrls: Error response from server:", res.status, errorData);
                document.getElementById('url-table-body').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">URL ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.message || errorData.error || res.statusText}</td></tr>`;
                return;
              }
    
              const data = await res.json(); //
              console.log("fetchUrls: Received data:", data); // ë””ë²„ê¹…ìš© ë¡œê·¸
    
              const tbody = document.getElementById('url-table-body'); //
              tbody.innerHTML = ''; // ë§¤ë²ˆ ì´ˆê¸°í™”
            
              if (data && data.length > 0) {
                data.forEach(item => { //
                  const tr = document.createElement('tr');
                  tr.className = "border-t"; //
                  tr.innerHTML = `
                    <td class="px-4 py-2">${new Date(item.created_at).toLocaleDateString()}</td>
                    <td class="px-4 py-2 text-indigo-600">
                      <a href="/r/${item.short_code}" target="_blank">/r/${item.short_code}</a>
                      <button onclick="copyUrl('${window.location.origin}/r/${item.short_code}')" class="ml-2 text-xs bg-gray-200 px-2 rounded">ë³µì‚¬</button>
                    </td>
                    <td class="px-4 py-2 break-all">${item.original_url}</td>
                    <td class="px-4 py-2 text-center">${item.clicks || 0}</td>
                    <td class="px-4 py-2">${item.memo || ''}</td>
                    <td>
                      <button onclick="deleteUrl('${item.short_code}')" class="text-red-500 text-xs">ì‚­ì œ</button>
                    </td>
                  `; //
                  tbody.appendChild(tr); //
                });
              } else if (data && data.error) {
                 console.error("fetchUrls: Backend error:", data.error);
                 tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">URL ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${data.error}</td></tr>`;
              }
              else {
                console.log("fetchUrls: No URLs found for this user."); // ë””ë²„ê¹…ìš© ë¡œê·¸
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">ì•„ì§ ë‹¨ì¶•í•œ URLì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
              }
          } catch (error) {
              console.error("fetchUrls: JavaScript error fetching URLs:", error);
              document.getElementById('url-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">URL ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
          }
        }
       
    </script>
    
    <script>
      async function fetchClickStats() {
        const res = await fetch('/.netlify/functions/fetch-clicks-by-date');
        const data = await res.json();
    
        const labels = data.map(item => item.date);
        const clicks = data.map(item => item.click_count);
    
        const ctx = document.getElementById('clickChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'í´ë¦­ ìˆ˜',
              data: clicks,
              backgroundColor: 'rgba(99, 102, 241, 0.2)',
              borderColor: 'rgba(99, 102, 241, 1)',
              borderWidth: 2,
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: { display: true, text: 'ë‚ ì§œ' }
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: 'í´ë¦­ ìˆ˜' }
              }
            }
          }
        });
      }
        
    </script>

<script>
  document.getElementById('search-btn').addEventListener('click', async function() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const keyword = document.getElementById('search-input').value.toLowerCase();

      const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();
      const user = session?.user;

      if (sessionError || !user) {
          alert("ê²€ìƒ‰ì„ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          document.getElementById('url-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-4">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</td></tr>';
          return;
      }
    
      fetch('/.netlify/functions/fetch-urls', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ user_id: user.id })
      })
        .then(res => {
          if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
          return res.json();
        })
        .then(data => {
          if (data.error) {
            console.error("Search error from backend:", data.error);
            document.getElementById('url-table-body').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: ${data.error}</td></tr>`;
            return;
          }
          const filtered = data.filter(item => {
            // ë‚ ì§œ í•„í„°
            const created = new Date(item.created_at).toISOString().slice(0,10);
            if (startDate && created < startDate) return false;
            if (endDate && created > endDate) return false;
            // í‚¤ì›Œë“œ(ë©”ëª¨/URL) í•„í„°
            if (keyword && !(item.memo?.toLowerCase().includes(keyword) || item.original_url?.toLowerCase().includes(keyword))) return false;
            return true;
          });
    
          // í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¬ê¸°
          const tbody = document.getElementById('url-table-body');
          tbody.innerHTML = '';
          if (filtered.length > 0) { 
            filtered.forEach(item => {
              const tr = document.createElement('tr');
              tr.className = "border-t";
              tr.innerHTML = `
                <td class="px-4 py-2">${new Date(item.created_at).toLocaleDateString()}</td>
                <td class="px-4 py-2 text-indigo-600">
                  <a href="/r/${item.short_code}" target="_blank">/r/${item.short_code}</a>
                  <button onclick="copyUrl('${window.location.origin}/r/${item.short_code}')" class="ml-2 text-xs bg-gray-200 px-2 rounded">ë³µì‚¬</button>
                </td>
                <td class="px-4 py-2 break-all">${item.original_url}</td>
                <td class="px-4 py-2 text-center">${item.clicks || 0}</td>
                <td class="px-4 py-2">${item.memo || ''}</td>
                <td>
                  <button onclick="deleteUrl('${item.short_code}')" class="text-red-500 text-xs">ì‚­ì œ</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          }
        })
        .catch(error => { 
            console.error("Search fetch error:", error);
            document.getElementById('url-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        });
    });
</script>

    <script>
      document.getElementById('export-btn').addEventListener('click', async () => {
        const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();
        const user = session?.user; // ì˜¬ë°”ë¥´ê²Œ user ê°€ì ¸ì˜¤ê¸° 

        if (sessionError || !user) {
            alert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            return;
        }
        
        fetch('/.netlify/functions/fetch-urls', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: user.id })
          })
          .then(res => {
            if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
            return res.json();
          })
          .then(data => {
            if (data.error) { // ë°±ì—”ë“œì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ì²˜ë¦¬
              console.error("Export error from backend:", data.error);
              alert(`ì—‘ì…€ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜: ${data.error}`);
              return;
            }
            const csv = data.map(row =>
              [
                new Date(row.created_at).toLocaleDateString(),
                `${window.location.origin}/r/${row.short_code}`,
                row.original_url,
                row.clicks || 0,
                row.memo || ''
              ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',') // CSV escaping ê°œì„ 
            ); //
            csv.unshift("ìƒì„±ì¼,ë‹¨ì¶• URL,ì›ë³¸ URL,í´ë¦­ ìˆ˜,ë©”ëª¨");
            const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'url-dashboard.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          })
          .catch(err => {
            console.error("Export fetch error:", err);
            alert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      });
    </script>

    <script>
      document.getElementById('reset-btn').addEventListener('click', () => {
        document.getElementById('start-date').value = '';
        document.getElementById('end-date').value = '';
        document.getElementById('search-input').value = '';
        document.getElementById('url-table-body').innerHTML = '';
        fetchUrls(); // ì „ì²´ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
      });
    </script>

    <script>
      function setDateRange(daysAgo) {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - daysAgo);
    
        const format = (d) => d.toISOString().split('T')[0];
        document.getElementById('start-date').value = format(start);
        document.getElementById('end-date').value = format(end);
      }
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // --- ë‚ ì§œ ê´€ë ¨ ì„¤ì • ---
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
    
        if (startDateInput) {
          startDateInput.value = today;
        }
        if (endDateInput) {
          endDateInput.value = today;
          endDateInput.setAttribute('max', today);
        }
    
        if (typeof window.initializeDashboard === 'function') {
          window.initializeDashboard();
        } else if (typeof initializeDashboard === 'function') {
          initializeDashboard();
        } else {
          console.error("Error: initializeDashboard function is not defined globally or in this scope.");
        }
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            await window.supabase.auth.signOut();
            window.location.href = "login.html";
          });
        }
      });
    </script>
            
</body>
</html>
